{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row">
        <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
            <h2 class="text-light"><i class="fas fa-crosshairs text-warning"></i> 5-Min ORB Sniper Configuration</h2>
            <div id="status-indicator" class="badge bg-secondary fs-5">LOADING...</div>
        </div>

        <div class="col-md-6">
            <div class="card bg-dark text-light border-secondary shadow">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">üöÄ Strategy Settings</h5>
                </div>
                <div class="card-body">
                    <form id="orbSettingsForm">
                        
                        <div class="mb-3">
                            <label class="form-label text-info">Select Index to Trade</label>
                            <select class="form-select bg-dark text-light border-secondary" id="index_selector">
                                <option value="NIFTY">NIFTY 50</option>
                                <option value="BANKNIFTY">BANK NIFTY</option>
                                <option value="FINNIFTY">FIN NIFTY</option>
                                <option value="ALL">ALL INDICES (Multi-Trade)</option>
                            </select>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Nifty Qty</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="qty_nifty" value="50">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">BankNifty Qty</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="qty_banknifty" value="15">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">FinNifty Qty</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="qty_finnifty" value="40">
                            </div>
                        </div>

                        <h6 class="text-warning mt-4">üõë Filters & Logic</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Min Range (Points)</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="min_range" value="10">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Max Range (Points)</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="max_range" value="300">
                            </div>
                        </div>

                        <h6 class="text-success mt-2">üéØ Targets & Buffer</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Buffer (Pts)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="buffer_points" value="1.0">
                                <small class="text-muted">Added to Breakout Trigger</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 1 Ratio</label>
                                <input type="number" step="0.1" class="form-control bg-dark text-light border-secondary" id="target1_ratio" value="1.0">
                                <small class="text-muted">1.0 = 1:1 Risk Reward</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 2 Ratio</label>
                                <input type="number" step="0.1" class="form-control bg-dark text-light border-secondary" id="target2_ratio" value="3.0">
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-primary" onclick="saveSettings()">üíæ Save Configuration</button>
                            <hr class="border-secondary">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success" id="btn_start" onclick="toggleStrategy('ENABLED')">‚ñ∂ START STRATEGY</button>
                                <button type="button" class="btn btn-outline-danger" id="btn_stop" onclick="toggleStrategy('DISABLED')">‚èπ STOP STRATEGY</button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card bg-dark text-light border-secondary shadow h-100">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">üìä Live Execution Status</h5>
                </div>
                <div class="card-body font-monospace" id="console_log" style="max-height: 500px; overflow-y: auto; font-size: 0.9em;">
                    <p class="text-muted">Waiting for updates...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load Settings on Page Load
    document.addEventListener("DOMContentLoaded", function() {
        fetch('/api/orb/settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('index_selector').value = data.selected_index || 'NIFTY';
                document.getElementById('qty_nifty').value = data.qty_map.NIFTY || 50;
                document.getElementById('qty_banknifty').value = data.qty_map.BANKNIFTY || 15;
                document.getElementById('qty_finnifty').value = data.qty_map.FINNIFTY || 40;
                
                document.getElementById('min_range').value = data.min_range || 10;
                document.getElementById('max_range').value = data.max_range || 300;
                document.getElementById('buffer_points').value = data.buffer_points || 1.0;
                document.getElementById('target1_ratio').value = data.risk_reward[0] || 1.0;
                document.getElementById('target2_ratio').value = data.risk_reward[1] || 3.0;

                updateStatusUI(data.status);
            });
            
        // Poll for logs/status
        setInterval(fetchStatus, 2000);
    });

    function saveSettings() {
        const payload = {
            selected_index: document.getElementById('index_selector').value,
            qty_map: {
                "NIFTY": parseInt(document.getElementById('qty_nifty').value),
                "BANKNIFTY": parseInt(document.getElementById('qty_banknifty').value),
                "FINNIFTY": parseInt(document.getElementById('qty_finnifty').value)
            },
            min_range: parseInt(document.getElementById('min_range').value),
            max_range: parseInt(document.getElementById('max_range').value),
            buffer_points: parseFloat(document.getElementById('buffer_points').value),
            risk_reward: [
                parseFloat(document.getElementById('target1_ratio').value),
                parseFloat(document.getElementById('target2_ratio').value)
            ]
        };

        fetch('/api/orb/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => alert(data.message));
    }

    function toggleStrategy(state) {
        fetch('/api/orb/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: state })
        })
        .then(res => res.json())
        .then(data => {
            updateStatusUI(data.new_status);
        });
    }

    function updateStatusUI(status) {
        const badge = document.getElementById('status-indicator');
        const btnStart = document.getElementById('btn_start');
        const btnStop = document.getElementById('btn_stop');

        if (status === 'ENABLED') {
            badge.className = "badge bg-success fs-5";
            badge.innerText = "RUNNING";
            btnStart.classList.add("active");
            btnStop.classList.remove("active");
        } else {
            badge.className = "badge bg-danger fs-5";
            badge.innerText = "STOPPED";
            btnStart.classList.remove("active");
            btnStop.classList.add("active");
        }
    }

    function fetchStatus() {
        fetch('/api/orb/logs')
            .then(res => res.json())
            .then(data => {
                let html = "";
                data.logs.forEach(log => {
                    html += `<div><span class="text-muted">[${log.time}]</span> ${log.msg}</div>`;
                });
                document.getElementById('console_log').innerHTML = html;
            });
    }
</script>
{% endblock %}
