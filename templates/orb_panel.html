{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row">
        <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-light"><i class="fas fa-crosshairs text-warning"></i> 5-Min ORB Sniper</h2>
                <small class="text-muted">Automated Opening Range Breakout System</small>
            </div>
            <div id="status-indicator" class="badge bg-secondary fs-5">LOADING...</div>
        </div>

        <div class="col-md-5">
            <div class="card bg-dark text-light border-secondary shadow">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üöÄ Strategy Configuration</h5>
                    <div class="badge bg-info text-dark" id="live_ltp_badge">LTP: ...</div>
                </div>
                <div class="card-body">
                    <form id="orbSettingsForm">
                        
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-info">Index</label>
                                <select class="form-select bg-dark text-light border-secondary" id="index_selector" onchange="fetchIndexDetails()">
                                    <option value="NIFTY">NIFTY 50</option>
                                    <option value="BANKNIFTY">BANK NIFTY</option>
                                    <option value="FINNIFTY">FIN NIFTY</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-warning">Trade Mode</label>
                                <select class="form-select bg-dark text-light border-secondary" id="trade_mode">
                                    <option value="PAPER">PAPER TRADING</option>
                                    <option value="LIVE">üî¥ LIVE TRADING</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Quantity</label>
                                <div class="input-group">
                                    <input type="number" class="form-control bg-dark text-light border-secondary" id="trade_qty">
                                    <button class="btn btn-outline-secondary" type="button" onclick="fetchIndexDetails()" title="Refresh Lot Size">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="form-text text-muted" id="lot_size_hint">Std Lot: --</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Order Type</label>
                                <select class="form-select bg-dark text-light border-secondary" id="order_type">
                                    <option value="MARKET">MARKET</option>
                                    <option value="SL-M">SL-M (Safer)</option>
                                </select>
                            </div>
                        </div>

                        <hr class="border-secondary">

                        <h6 class="text-warning"><i class="fas fa-filter"></i> üõë Filters & Logic</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Min Range (Pts)</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="min_range">
                                <small class="text-muted" style="font-size: 0.7rem;">Prevents trading in flat/choppy markets.</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Max Range (Pts)</label>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="max_range">
                                <small class="text-muted" style="font-size: 0.7rem;">Avoids entries after massive exhausted moves.</small>
                            </div>
                        </div>

                        <h6 class="text-success mt-3"><i class="fas fa-bullseye"></i> Targets & Buffer</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Buffer (Pts)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="buffer_points">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 1 (xSL)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="target1_ratio">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 2 (xSL)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="target2_ratio">
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-primary fw-bold" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save Configuration
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success" id="btn_start" onclick="toggleStrategy('ENABLED')">‚ñ∂ START STRATEGY</button>
                                <button type="button" class="btn btn-outline-danger" id="btn_stop" onclick="toggleStrategy('DISABLED')">‚èπ STOP STRATEGY</button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card bg-dark text-light border-secondary shadow h-100">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">üìä Live Strategy Logs</h5>
                </div>
                <div class="card-body font-monospace p-0" style="background-color: #0d1117;">
                    <div id="console_log" class="p-3" style="max-height: 600px; overflow-y: auto; font-size: 0.85rem; color: #c9d1d9;">
                        <span class="text-muted">Waiting for strategy events...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", function() {
        loadSettings();
        setInterval(fetchLogs, 2000); // Poll logs every 2s
        setInterval(refreshLTP, 5000); // Poll LTP every 5s
    });

    // --- AUTO-FETCH LTP & LOT SIZE ---
    function fetchIndexDetails() {
        const symbol = document.getElementById('index_selector').value;
        const btn = document.getElementById('lot_size_hint');
        
        // Call main system API to get details
        fetch(`/api/details?symbol=${symbol}`)
            .then(res => res.json())
            .then(data => {
                if(data.ltp) {
                    document.getElementById('live_ltp_badge').innerText = `LTP: ${data.ltp}`;
                    document.getElementById('live_ltp_badge').className = "badge bg-success text-white";
                }
                
                if(data.lot_size) {
                    document.getElementById('lot_size_hint').innerText = `Std Lot: ${data.lot_size}`;
                    
                    // Auto-fill IF the field is empty or user requests it
                    const currentQty = document.getElementById('trade_qty').value;
                    if(!currentQty || currentQty == 0) {
                        document.getElementById('trade_qty').value = data.lot_size;
                    }
                }
            })
            .catch(err => console.error("Error fetching details:", err));
    }

    function refreshLTP() {
        const symbol = document.getElementById('index_selector').value;
        fetch(`/api/details?symbol=${symbol}`)
            .then(res => res.json())
            .then(data => {
                if(data.ltp) document.getElementById('live_ltp_badge').innerText = `LTP: ${data.ltp}`;
            });
    }

    // --- SETTINGS MANAGEMENT ---
    function loadSettings() {
        fetch('/api/orb/settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('index_selector').value = data.selected_index || 'NIFTY';
                document.getElementById('trade_mode').value = data.trade_mode || 'PAPER';
                document.getElementById('order_type').value = data.order_type || 'MARKET';
                
                // Load Quantity for specific index
                const qtyMap = data.qty_map || {};
                const currentIdx = data.selected_index || 'NIFTY';
                document.getElementById('trade_qty').value = qtyMap[currentIdx] || 50;

                document.getElementById('min_range').value = data.min_range || 10;
                document.getElementById('max_range').value = data.max_range || 300;
                document.getElementById('buffer_points').value = data.buffer_points || 1.0;
                document.getElementById('target1_ratio').value = data.risk_reward[0] || 1.0;
                document.getElementById('target2_ratio').value = data.risk_reward[1] || 3.0;

                updateStatusUI(data.status);
                fetchIndexDetails(); // Initial fetch
            });
    }

    function saveSettings() {
        const idx = document.getElementById('index_selector').value;
        const currentQty = parseInt(document.getElementById('trade_qty').value);
        
        // We need to fetch current config first to preserve other indices' quantities
        fetch('/api/orb/settings')
            .then(res => res.json())
            .then(currentConfig => {
                const qtyMap = currentConfig.qty_map || {};
                qtyMap[idx] = currentQty; // Update only current index

                const payload = {
                    selected_index: idx,
                    trade_mode: document.getElementById('trade_mode').value,
                    order_type: document.getElementById('order_type').value,
                    qty_map: qtyMap,
                    min_range: parseInt(document.getElementById('min_range').value),
                    max_range: parseInt(document.getElementById('max_range').value),
                    buffer_points: parseFloat(document.getElementById('buffer_points').value),
                    risk_reward: [
                        parseFloat(document.getElementById('target1_ratio').value),
                        parseFloat(document.getElementById('target2_ratio').value)
                    ]
                };

                fetch('/api/orb/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => alert(data.message));
            });
    }

    function toggleStrategy(state) {
        fetch('/api/orb/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: state })
        })
        .then(res => res.json())
        .then(data => updateStatusUI(data.new_status));
    }

    function updateStatusUI(status) {
        const badge = document.getElementById('status-indicator');
        const btnStart = document.getElementById('btn_start');
        const btnStop = document.getElementById('btn_stop');

        if (status === 'ENABLED') {
            badge.className = "badge bg-success fs-5";
            badge.innerText = "RUNNING";
            btnStart.classList.add("active");
            btnStop.classList.remove("active");
        } else {
            badge.className = "badge bg-danger fs-5";
            badge.innerText = "STOPPED";
            btnStart.classList.remove("active");
            btnStop.classList.add("active");
        }
    }

    function fetchLogs() {
        fetch('/api/orb/logs')
            .then(res => res.json())
            .then(data => {
                let html = "";
                data.logs.forEach(log => {
                    let colorClass = "text-light";
                    if(log.msg.includes("TRIGGER")) colorClass = "text-warning fw-bold";
                    if(log.msg.includes("Trade Placed")) colorClass = "text-success fw-bold";
                    if(log.msg.includes("Error") || log.msg.includes("Rejection")) colorClass = "text-danger";
                    
                    html += `<div class="border-bottom border-secondary py-1"><span class="text-muted" style="font-size:0.75em">[${log.time}]</span> <span class="${colorClass}">${log.msg}</span></div>`;
                });
                document.getElementById('console_log').innerHTML = html;
            });
    }
</script>
{% endblock %}
