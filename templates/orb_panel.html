{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row">
        <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-light"><i class="fas fa-crosshairs text-warning"></i> 5-Min ORB Sniper</h2>
                <small class="text-muted">Single-Single Index Configuration</small>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-outline-info fw-bold" data-bs-toggle="modal" data-bs-target="#viewConfigModal" onclick="loadSavedTable()">
                    üìã View Saved Strategies
                </button>
                <div id="status-indicator" class="badge bg-secondary fs-5">LOADING...</div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card bg-dark text-light border-secondary shadow">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üöÄ Configure Index</h5>
                    <div class="badge bg-info text-dark" id="live_ltp_badge">LTP: ...</div>
                </div>
                <div class="card-body">
                    <form id="orbSettingsForm">
                        
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-info">Select Index</label>
                                <select class="form-select bg-dark text-light border-secondary" id="index_selector" onchange="loadIndexSettings()">
                                    <option value="NIFTY">NIFTY 50</option>
                                    <option value="BANKNIFTY">BANK NIFTY</option>
                                    <option value="FINNIFTY">FIN NIFTY</option>
                                    <option value="SENSEX">SENSEX</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-warning">Trade Mode</label>
                                <select class="form-select bg-dark text-light border-secondary" id="trade_mode">
                                    <option value="PAPER">PAPER TRADING</option>
                                    <option value="LIVE">üî¥ LIVE TRADING</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Quantity (Lots)</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" onclick="adjQty(-1)" id="btn_minus">-</button>
                                    <input type="number" class="form-control bg-dark text-light border-secondary text-center" id="trade_qty" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="adjQty(1)" id="btn_plus">+</button>
                                </div>
                                <div class="form-text text-muted" id="lot_size_hint">Std Lot: --</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Order Type</label>
                                <select class="form-select bg-dark text-light border-secondary" id="order_type">
                                    <option value="MARKET">MARKET</option>
                                    <option value="SL-M">SL-M (Safer)</option>
                                </select>
                            </div>
                        </div>

                        <hr class="border-secondary">

                        <h6 class="text-success mt-3"><i class="fas fa-bullseye"></i> Targets & Buffer</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Buffer (Pts)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="buffer_points" value="1.0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 1 (xSL)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="target1_ratio" value="1.0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 2 (xSL)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="target2_ratio" value="3.0">
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-primary fw-bold" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save Configuration
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success" id="btn_start" onclick="toggleStrategy('ENABLED')">‚ñ∂ START BOT</button>
                                <button type="button" class="btn btn-outline-danger" id="btn_stop" onclick="toggleStrategy('DISABLED')">‚èπ STOP BOT</button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card bg-dark text-light border-secondary shadow h-100">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">üìä Live Strategy Logs</h5>
                </div>
                <div class="card-body font-monospace p-0" style="background-color: #0d1117;">
                    <div id="console_log" class="p-3" style="max-height: 600px; overflow-y: auto; font-size: 0.85rem; color: #c9d1d9;">
                        <span class="text-muted">Waiting for strategy events...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">üíæ Active Strategies</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover border-secondary table-sm align-middle">
                        <thead>
                            <tr class="text-secondary text-uppercase small">
                                <th>Index</th>
                                <th>Mode</th>
                                <th>Qty</th>
                                <th>Type</th>
                                <th>Buffer</th>
                                <th>Targets</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody id="saved_config_body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let curLotSize = 0; 
    let globalStrategies = {}; // Stores all saved strategies

    document.addEventListener("DOMContentLoaded", function() {
        fetchAllSettings();
        setInterval(fetchLogs, 2000);
        setInterval(refreshLTP, 5000);
    });

    // 1. Fetch All Settings & Status
    function fetchAllSettings() {
        fetch('/api/orb/settings')
            .then(response => response.json())
            .then(data => {
                globalStrategies = data.strategies || {};
                updateStatusUI(data.status);
                loadIndexSettings(); // Load UI for currently selected index
            })
            .catch(err => console.error("Init Error:", err));
    }

    // 2. Load UI based on Selected Index
    function loadIndexSettings() {
        const idx = document.getElementById('index_selector').value;
        const saved = globalStrategies[idx]; // Check if we have saved config for this index

        // Fetch LTP & Lot Size Logic
        fetch(`/api/details?symbol=${idx}`)
            .then(res => res.json())
            .then(data => {
                curLotSize = data.lot_size || 0;
                document.getElementById('lot_size_hint').innerText = `Std Lot: ${curLotSize}`;
                
                if(data.ltp) {
                    const ltpBadge = document.getElementById('live_ltp_badge');
                    ltpBadge.innerText = `LTP: ${data.ltp}`;
                    ltpBadge.className = "badge bg-success text-white";
                }

                // Populate Form: Use Saved if exists, else Default
                if (saved) {
                    document.getElementById('trade_mode').value = saved.trade_mode || 'PAPER';
                    document.getElementById('order_type').value = saved.order_type || 'MARKET';
                    document.getElementById('trade_qty').value = saved.qty || curLotSize;
                    document.getElementById('buffer_points').value = saved.buffer_points || 1.0;
                    document.getElementById('target1_ratio').value = saved.risk_reward[0] || 1.0;
                    document.getElementById('target2_ratio').value = saved.risk_reward[1] || 3.0;
                } else {
                    // Defaults
                    document.getElementById('trade_mode').value = 'PAPER';
                    document.getElementById('order_type').value = 'MARKET';
                    document.getElementById('trade_qty').value = curLotSize; // Default to 1 lot
                    document.getElementById('buffer_points').value = 1.0;
                    document.getElementById('target1_ratio').value = 1.0;
                    document.getElementById('target2_ratio').value = 3.0;
                }
            });
    }

    // 3. Save Single Index Configuration
    function saveSettings() {
        const idx = document.getElementById('index_selector').value;
        
        const config = {
            qty: parseInt(document.getElementById('trade_qty').value) || 0,
            trade_mode: document.getElementById('trade_mode').value,
            order_type: document.getElementById('order_type').value,
            buffer_points: parseFloat(document.getElementById('buffer_points').value),
            risk_reward: [
                parseFloat(document.getElementById('target1_ratio').value),
                parseFloat(document.getElementById('target2_ratio').value)
            ]
        };

        fetch('/api/orb/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ index: idx, config: config })
        })
        .then(res => res.json())
        .then(data => {
            alert("‚úÖ " + data.message);
            fetchAllSettings(); // Refresh local data
        });
    }

    // 4. View Saved Table
    function loadSavedTable() {
        const tbody = document.getElementById('saved_config_body');
        tbody.innerHTML = "";
        
        const keys = Object.keys(globalStrategies);
        if (keys.length === 0) {
            tbody.innerHTML = "<tr><td colspan='7' class='text-center text-muted py-3'>No strategies configured. Save one to see it here.</td></tr>";
            return;
        }

        keys.forEach(idx => {
            const s = globalStrategies[idx];
            let modeBadge = s.trade_mode === 'LIVE' ? '<span class="badge bg-danger">LIVE</span>' : '<span class="badge bg-primary">PAPER</span>';
            
            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold text-info">${idx}</td>
                    <td>${modeBadge}</td>
                    <td>${s.qty}</td>
                    <td class="small">${s.order_type}</td>
                    <td>${s.buffer_points}</td>
                    <td>1:${s.risk_reward[0]} / 1:${s.risk_reward[1]}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteConfig('${idx}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    function deleteConfig(idx) {
        if (!confirm(`Delete configuration for ${idx}?`)) return;

        fetch('/api/orb/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ index: idx })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            fetchAllSettings(); // Refresh UI
            loadSavedTable(); // Refresh Modal
        });
    }

    // Utils
    function adjQty(dir) {
        if (curLotSize === 0) return;
        let qtyField = document.getElementById('trade_qty');
        let current = parseInt(qtyField.value) || 0;
        let newVal = current + (dir * curLotSize);
        if (newVal >= curLotSize) qtyField.value = newVal;
    }

    function refreshLTP() {
        const symbol = document.getElementById('index_selector').value;
        fetch(`/api/details?symbol=${symbol}`)
            .then(res => res.json())
            .then(data => {
                if(data.ltp) document.getElementById('live_ltp_badge').innerText = `LTP: ${data.ltp}`;
            });
    }

    function toggleStrategy(state) {
        fetch('/api/orb/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: state })
        })
        .then(res => res.json())
        .then(data => updateStatusUI(data.new_status));
    }

    function updateStatusUI(status) {
        const badge = document.getElementById('status-indicator');
        const btnStart = document.getElementById('btn_start');
        const btnStop = document.getElementById('btn_stop');

        if (status === 'ENABLED') {
            badge.className = "badge bg-success fs-5";
            badge.innerText = "RUNNING";
            btnStart.classList.add("active");
            btnStop.classList.remove("active");
        } else {
            badge.className = "badge bg-danger fs-5";
            badge.innerText = "STOPPED";
            btnStart.classList.remove("active");
            btnStop.classList.add("active");
        }
    }

    function fetchLogs() {
        fetch('/api/orb/logs')
            .then(res => res.json())
            .then(data => {
                if(!data.logs) return;
                let html = "";
                data.logs.forEach(log => {
                    let colorClass = "text-light";
                    if(log.msg.includes("TRIGGER")) colorClass = "text-warning fw-bold";
                    if(log.msg.includes("Placed")) colorClass = "text-success fw-bold";
                    html += `<div class="border-bottom border-secondary py-1"><span class="text-muted" style="font-size:0.75em">[${log.time}]</span> <span class="${colorClass}">${log.msg}</span></div>`;
                });
                document.getElementById('console_log').innerHTML = html;
            });
    }
</script>
{% endblock %}
