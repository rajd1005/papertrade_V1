{% extends "dashboard.html" %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row">
        <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-light"><i class="fas fa-crosshairs text-warning"></i> 5-Min ORB Sniper</h2>
                <small class="text-muted">Automated Opening Range Breakout System</small>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <button class="btn btn-outline-info fw-bold" data-bs-toggle="modal" data-bs-target="#viewConfigModal" onclick="loadSavedTable()">
                    üìã View Saved
                </button>
                <div id="status-indicator" class="badge bg-secondary fs-5">LOADING...</div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card bg-dark text-light border-secondary shadow">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üöÄ Strategy Configuration</h5>
                    <div class="badge bg-info text-dark" id="live_ltp_badge">LTP: ...</div>
                </div>
                <div class="card-body">
                    <form id="orbSettingsForm">
                        
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label text-info">Index</label>
                                <select class="form-select bg-dark text-light border-secondary" id="index_selector" onchange="fetchIndexDetails(true)">
                                    <option value="NIFTY">NIFTY 50</option>
                                    <option value="BANKNIFTY">BANK NIFTY</option>
                                    <option value="FINNIFTY">FIN NIFTY</option>
                                    <option value="SENSEX">SENSEX</option>
                                    <option value="ALL" class="fw-bold text-warning">üåü ALL INDICES</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-warning">Trade Mode</label>
                                <select class="form-select bg-dark text-light border-secondary" id="trade_mode">
                                    <option value="PAPER">PAPER TRADING</option>
                                    <option value="LIVE">üî¥ LIVE TRADING</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Quantity (Lots)</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" onclick="adjQty(-1)" id="btn_minus">-</button>
                                    <input type="number" class="form-control bg-dark text-light border-secondary text-center" id="trade_qty" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="adjQty(1)" id="btn_plus">+</button>
                                </div>
                                <div class="form-text text-muted" id="lot_size_hint">Std Lot: --</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Order Type</label>
                                <select class="form-select bg-dark text-light border-secondary" id="order_type">
                                    <option value="MARKET">MARKET</option>
                                    <option value="SL-M">SL-M (Safer)</option>
                                </select>
                            </div>
                        </div>

                        <hr class="border-secondary">

                        <h6 class="text-success mt-3"><i class="fas fa-bullseye"></i> Targets & Buffer</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Buffer (Pts)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="buffer_points">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 1 (xSL)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="target1_ratio">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Target 2 (xSL)</label>
                                <input type="number" step="0.5" class="form-control bg-dark text-light border-secondary" id="target2_ratio">
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-primary fw-bold" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save Configuration
                            </button>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success" id="btn_start" onclick="toggleStrategy('ENABLED')">‚ñ∂ START STRATEGY</button>
                                <button type="button" class="btn btn-outline-danger" id="btn_stop" onclick="toggleStrategy('DISABLED')">‚èπ STOP STRATEGY</button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card bg-dark text-light border-secondary shadow h-100">
                <div class="card-header border-secondary">
                    <h5 class="mb-0">üìä Live Strategy Logs</h5>
                </div>
                <div class="card-body font-monospace p-0" style="background-color: #0d1117;">
                    <div id="console_log" class="p-3" style="max-height: 600px; overflow-y: auto; font-size: 0.85rem; color: #c9d1d9;">
                        <span class="text-muted">Waiting for strategy events...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewConfigModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">üíæ Saved Indices (Active in ALL Mode)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-dark table-hover border-secondary">
                    <thead>
                        <tr>
                            <th>Index</th>
                            <th>Qty</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody id="saved_config_body">
                        </tbody>
                </table>
                <div class="mt-3 text-center">
                    <button class="btn btn-sm btn-outline-danger w-100" onclick="deleteConfig('RESET_ALL')">
                        ‚ö†Ô∏è Reset All Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let curLotSize = 0; 
    let globalConfig = {}; // Store config locally

    document.addEventListener("DOMContentLoaded", function() {
        fetch('/api/orb/settings')
            .then(response => response.json())
            .then(data => {
                globalConfig = data;
                applySettings(data);
                setInterval(fetchLogs, 2000);
                setInterval(refreshLTP, 5000);
            })
            .catch(err => {
                console.error("Init Error:", err);
                document.getElementById('status-indicator').innerText = "ERROR";
            });
    });

    function applySettings(data) {
        document.getElementById('index_selector').value = data.selected_index || 'NIFTY';
        document.getElementById('trade_mode').value = data.trade_mode || 'PAPER';
        document.getElementById('order_type').value = data.order_type || 'MARKET';
        document.getElementById('buffer_points').value = data.buffer_points || 1.0;
        document.getElementById('target1_ratio').value = data.risk_reward[0] || 1.0;
        document.getElementById('target2_ratio').value = data.risk_reward[1] || 3.0;

        fetchIndexDetails(false, data.qty_map); 
        updateStatusUI(data.status);
    }

    function loadSavedTable() {
        fetch('/api/orb/settings')
            .then(res => res.json())
            .then(data => {
                globalConfig = data;
                let tbody = document.getElementById('saved_config_body');
                tbody.innerHTML = "";
                
                let qtyMap = data.qty_map || {};
                
                // Show items that have Qty > 0
                for (let [idx, qty] of Object.entries(qtyMap)) {
                    if (qty > 0) {
                        tbody.innerHTML += `
                            <tr>
                                <td class="fw-bold text-info">${idx}</td>
                                <td>${qty}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-danger" onclick="deleteConfig('${idx}')" title="Delete & Exclude">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                }

                if (tbody.innerHTML === "") {
                    tbody.innerHTML = "<tr><td colspan='3' class='text-center text-muted'>No indices configured yet.</td></tr>";
                }
            });
    }

    function deleteConfig(idx) {
        if (!confirm(`Are you sure you want to delete settings for ${idx}?`)) return;

        fetch('/api/orb/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ index: idx })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            loadSavedTable(); // Refresh Modal
            fetchIndexDetails(true); // Refresh main form if needed
        });
    }

    function fetchIndexDetails(userInitiated=false, savedQtyMap=null) {
        const symbol = document.getElementById('index_selector').value;
        const qtyField = document.getElementById('trade_qty');
        const hint = document.getElementById('lot_size_hint');
        const ltpBadge = document.getElementById('live_ltp_badge');

        if (symbol === 'ALL') {
            qtyField.value = "MULTI";
            qtyField.disabled = true;
            document.getElementById('btn_plus').disabled = true;
            document.getElementById('btn_minus').disabled = true;
            hint.innerText = "Configured Individually";
            ltpBadge.innerText = "Mode: Multi-Index";
            ltpBadge.className = "badge bg-warning text-dark";
            return;
        }

        qtyField.disabled = false;
        document.getElementById('btn_plus').disabled = false;
        document.getElementById('btn_minus').disabled = false;

        fetch(`/api/details?symbol=${symbol}`)
            .then(res => res.json())
            .then(data => {
                if(data.ltp) {
                    ltpBadge.innerText = `LTP: ${data.ltp}`;
                    ltpBadge.className = "badge bg-success text-white";
                }
                
                if(data.lot_size > 0) {
                    curLotSize = data.lot_size;
                    hint.innerText = `Std Lot: ${curLotSize}`;
                    
                    if (savedQtyMap && savedQtyMap[symbol]) {
                        qtyField.value = savedQtyMap[symbol];
                    } else if (userInitiated || !qtyField.value || qtyField.value === "MULTI") {
                        qtyField.value = curLotSize;
                    }
                }
            });
    }

    function adjQty(dir) {
        if (curLotSize === 0 || document.getElementById('index_selector').value === 'ALL') return;
        let qtyField = document.getElementById('trade_qty');
        let current = parseInt(qtyField.value) || 0;
        let newVal = current + (dir * curLotSize);
        if (newVal >= curLotSize) qtyField.value = newVal;
    }

    function refreshLTP() {
        const symbol = document.getElementById('index_selector').value;
        if(symbol === 'ALL') return;
        fetch(`/api/details?symbol=${symbol}`)
            .then(res => res.json())
            .then(data => {
                if(data.ltp) document.getElementById('live_ltp_badge').innerText = `LTP: ${data.ltp}`;
            });
    }

    function saveSettings() {
        const idx = document.getElementById('index_selector').value;
        
        let payload = {
            selected_index: idx,
            trade_mode: document.getElementById('trade_mode').value,
            order_type: document.getElementById('order_type').value,
            buffer_points: parseFloat(document.getElementById('buffer_points').value),
            risk_reward: [
                parseFloat(document.getElementById('target1_ratio').value),
                parseFloat(document.getElementById('target2_ratio').value)
            ]
        };

        if (idx !== 'ALL') {
            const currentQty = parseInt(document.getElementById('trade_qty').value) || 0;
            payload.qty_map = { [idx]: currentQty };
        }

        fetch('/api/orb/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => alert("‚úÖ " + data.message));
    }

    function toggleStrategy(state) {
        fetch('/api/orb/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: state })
        })
        .then(res => res.json())
        .then(data => updateStatusUI(data.new_status));
    }

    function updateStatusUI(status) {
        const badge = document.getElementById('status-indicator');
        const btnStart = document.getElementById('btn_start');
        const btnStop = document.getElementById('btn_stop');

        if (status === 'ENABLED') {
            badge.className = "badge bg-success fs-5";
            badge.innerText = "RUNNING";
            btnStart.classList.add("active");
            btnStop.classList.remove("active");
        } else {
            badge.className = "badge bg-danger fs-5";
            badge.innerText = "STOPPED";
            btnStart.classList.remove("active");
            btnStop.classList.add("active");
        }
    }

    function fetchLogs() {
        fetch('/api/orb/logs')
            .then(res => res.json())
            .then(data => {
                if(!data.logs) return;
                let html = "";
                data.logs.forEach(log => {
                    let colorClass = "text-light";
                    if(log.msg.includes("TRIGGER")) colorClass = "text-warning fw-bold";
                    if(log.msg.includes("Trade Placed")) colorClass = "text-success fw-bold";
                    if(log.msg.includes("Error") || log.msg.includes("Rejection")) colorClass = "text-danger";
                    html += `<div class="border-bottom border-secondary py-1"><span class="text-muted" style="font-size:0.75em">[${log.time}]</span> <span class="${colorClass}">${log.msg}</span></div>`;
                });
                document.getElementById('console_log').innerHTML = html;
            });
    }
</script>
{% endblock %}
